# 在线课程学习平台 - 技术操作手册

## 工程师指南 v1.0

---

## 目录

1. [环境部署](#1-环境部署)
2. [项目结构](#2-项目结构)
3. [数据库配置](#3-数据库配置)
4. [用户权限系统](#4-用户权限系统)
5. [前端测试指南](#5-前端测试指南)
6. [后端测试指南](#6-后端测试指南)
7. [CRUD操作说明](#7-crud操作说明)
8. [SQL查询验证](#8-sql查询验证)
9. [故障排除](#9-故障排除)
10. [部署上线](#10-部署上线)

---

## 1. 环境部署

### 1.1 系统要求

- Python 3.8+
- pip 包管理器
- 现代浏览器 (Chrome/Firefox/Edge)

### 1.2 安装步骤

```bash
# 1. 安装依赖
pip install flask

# 2. 进入项目目录
cd online_learning_platform

# 3. 启动应用
python app.py

# 4. 访问地址
http://localhost:5000
```

### 1.3 首次启动

首次运行时，系统会自动：
- 创建 SQLite 数据库文件 `learning_platform.db`
- 初始化所有表结构（15个表）
- 插入示例数据（用户、课程、订单等）

---

## 2. 项目结构

```
online_learning_platform/
│
├── app.py                    # 主应用文件（所有路由和逻辑）
├── learning_platform.db      # SQLite数据库（运行后生成）
│
├── static/
│   ├── css/style.css        # 自定义样式
│   └── js/main.js           # JavaScript脚本
│
├── templates/               # HTML模板（英文界面）
│   ├── base.html           # 基础模板
│   ├── index.html          # 首页
│   ├── login.html          # 登录页
│   ├── register.html       # 注册页
│   ├── courses.html        # 课程列表
│   ├── course_detail.html  # 课程详情
│   ├── profile.html        # 个人中心
│   ├── edit_profile.html   # 编辑资料
│   ├── learn.html          # 学习页面
│   ├── demo_queries.html   # SQL演示页
│   ├── 404.html            # 404页面
│   └── admin/
│       ├── courses.html    # 课程管理列表
│       └── course_form.html# 课程创建/编辑表单
│
├── sql/
│   ├── database_schema.sql  # MySQL建表脚本
│   └── complex_queries.sql  # 复杂SQL查询示例
│
└── docs/
    └── project_report.docx  # 项目报告
```

---

## 3. 数据库配置

### 3.1 开发环境（SQLite）

默认使用 SQLite，无需额外配置。数据库文件自动生成于项目根目录。

### 3.2 生产环境（MySQL）

如需切换到 MySQL：

```python
# 修改 app.py 中的数据库连接
import pymysql

def get_db():
    conn = pymysql.connect(
        host='localhost',
        user='root',
        password='your_password',
        database='online_learning_platform',
        charset='utf8mb4',
        cursorclass=pymysql.cursors.DictCursor
    )
    return conn
```

执行 `sql/database_schema.sql` 初始化 MySQL 数据库。

### 3.3 数据库表结构

| 序号 | 表名 | 说明 | 关系类型 |
|-----|------|------|---------|
| 1 | user | 用户基本信息 | - |
| 2 | user_profile | 用户详情 | 1:1 与 user |
| 3 | role | 角色定义 | - |
| 4 | user_role | 用户角色关联 | M:N |
| 5 | category | 课程分类 | 自关联 |
| 6 | course | 课程主表 | - |
| 7 | chapter | 章节 | 1:N 属于 course |
| 8 | lesson | 课时 | 1:N 属于 chapter |
| 9 | order | 订单 | - |
| 10 | order_item | 订单明细 | 1:N 属于 order |
| 11 | enrollment | 选课记录 | M:N user-course |
| 12 | learning_progress | 学习进度 | - |
| 13 | review | 课程评价 | - |
| 14 | favorite | 收藏 | - |
| 15 | cart | 购物车 | - |

---

## 4. 用户权限系统

### 4.1 角色定义

| 角色 | role_id | 权限说明 |
|-----|---------|---------|
| student | 1 | 浏览课程、购买、学习、评价、收藏 |
| instructor | 2 | 创建/编辑/删除自己的课程 |
| admin | 3 | 管理所有用户和课程 |

### 4.2 测试账号

| 角色 | 邮箱 | 密码 | 用途 |
|-----|------|------|-----|
| 学员 | zhangsan@example.com | password123 | 测试学习功能 |
| 学员 | lisi@example.com | password123 | 测试购买功能 |
| 讲师 | wanglaoshi@example.com | password123 | 测试课程管理 |
| 讲师 | liulaoshi@example.com | password123 | 测试课程创建 |
| 管理员 | admin@example.com | password123 | 测试管理功能 |

### 4.3 权限控制代码

```python
# 登录装饰器
@login_required
def some_route():
    pass

# 角色检查
if 'instructor' in session.get('roles', []):
    # 讲师权限操作
    
if 'admin' in session.get('roles', []):
    # 管理员权限操作
```

### 4.4 权限测试流程

1. **学员权限测试**：
   - 登录 zhangsan@example.com
   - 验证：可浏览、购买、学习课程
   - 验证：无法访问 `/admin/courses`

2. **讲师权限测试**：
   - 登录 wanglaoshi@example.com
   - 验证：可访问课程管理页面
   - 验证：只能编辑/删除自己的课程

3. **管理员权限测试**：
   - 登录 admin@example.com
   - 验证：可管理所有课程

---

## 5. 前端测试指南

### 5.1 页面测试清单

| 页面 | URL | 测试要点 |
|-----|-----|---------|
| 首页 | `/` | 推荐课程显示、分类展示 |
| 登录 | `/login` | 表单验证、错误提示 |
| 注册 | `/register` | 表单验证、密码确认 |
| 课程列表 | `/courses` | 筛选、排序、搜索 |
| 课程详情 | `/course/<id>` | 章节展开、购买按钮 |
| 个人中心 | `/profile` | 学习进度、收藏列表 |
| 学习页 | `/learn/<id>` | 课时导航、进度显示 |
| SQL演示 | `/demo/queries` | 11种查询结果展示 |

### 5.2 响应式测试

使用浏览器开发者工具测试：
- 桌面端 (1920x1080)
- 平板端 (768x1024)
- 手机端 (375x667)

### 5.3 功能测试脚本

```
【测试用例1：用户注册】
1. 访问 /register
2. 输入用户名、邮箱、密码
3. 点击注册
4. 预期：跳转登录页，显示成功提示

【测试用例2：课程购买】
1. 登录学员账号
2. 浏览课程详情
3. 点击"Buy Now"或"Enroll Free"
4. 预期：创建订单，跳转学习页

【测试用例3：课程CRUD】
1. 登录讲师账号
2. 访问 /admin/courses
3. 创建新课程 -> 编辑课程 -> 删除课程
4. 预期：各操作成功执行
```

---

## 6. 后端测试指南

### 6.1 API路由清单

| 方法 | 路由 | 功能 | 需登录 |
|-----|------|------|-------|
| GET | `/` | 首页 | 否 |
| GET/POST | `/login` | 登录 | 否 |
| GET/POST | `/register` | 注册 | 否 |
| GET | `/logout` | 登出 | 是 |
| GET | `/courses` | 课程列表 | 否 |
| GET | `/course/<id>` | 课程详情 | 否 |
| GET | `/profile` | 个人中心 | 是 |
| GET/POST | `/profile/edit` | 编辑资料 | 是 |
| POST | `/favorite/<id>` | 收藏/取消 | 是 |
| POST | `/enroll/<id>` | 购买课程 | 是 |
| GET | `/learn/<id>` | 学习页面 | 是 |
| GET | `/admin/courses` | 课程管理 | 是(讲师/管理员) |
| GET/POST | `/admin/course/create` | 创建课程 | 是(讲师/管理员) |
| GET/POST | `/admin/course/<id>/edit` | 编辑课程 | 是(讲师/管理员) |
| POST | `/admin/course/<id>/delete` | 删除课程 | 是(讲师/管理员) |
| GET | `/demo/queries` | SQL演示 | 否 |

### 6.2 单元测试命令

```bash
# 测试数据库初始化
python -c "from app import init_db; init_db(); print('OK')"

# 测试数据库连接
python -c "from app import get_db; db=get_db(); print(db.execute('SELECT COUNT(*) FROM user').fetchone())"
```

### 6.3 后端日志

Flask 调试模式下会在控制台输出：
- 请求方法和URL
- 响应状态码
- 错误堆栈信息

---

## 7. CRUD操作说明

### 7.1 Create（创建）

**路由**：`POST /admin/course/create`

**流程**：
1. 验证用户角色（instructor/admin）
2. 接收表单数据：title, subtitle, description, category_id, price, level
3. 插入 course 表
4. 重定向到课程管理页

**SQL**：
```sql
INSERT INTO course (title, subtitle, description, instructor_id, category_id, price, level, status)
VALUES (?, ?, ?, ?, ?, ?, ?, 'draft')
```

### 7.2 Read（读取）

**路由**：`GET /courses`, `GET /course/<id>`

**列表查询**：
```sql
SELECT c.*, u.username as instructor_name, cat.category_name
FROM course c
LEFT JOIN user u ON c.instructor_id = u.user_id
LEFT JOIN category cat ON c.category_id = cat.category_id
WHERE c.status = 'published'
ORDER BY c.published_at DESC
```

### 7.3 Update（更新）

**路由**：`POST /admin/course/<id>/edit`

**权限检查**：
```python
if 'admin' not in session.get('roles', []) and course['instructor_id'] != session['user_id']:
    flash('No permission to edit this course', 'error')
```

**SQL**：
```sql
UPDATE course SET title=?, subtitle=?, description=?, category_id=?, price=?, level=?, status=?
WHERE course_id=?
```

### 7.4 Delete（删除）

**路由**：`POST /admin/course/<id>/delete`

**前置检查**：
```sql
-- 检查是否有学员购买
SELECT COUNT(*) as count FROM enrollment WHERE course_id = ?
```

**删除操作**：
```sql
DELETE FROM course WHERE course_id = ?
```

---

## 8. SQL查询验证

### 8.1 验证方法

访问 `/demo/queries` 页面，可查看所有11种查询的：
- SQL语句
- 执行结果

### 8.2 查询类型清单

| # | 类型 | 验证要点 |
|---|-----|---------|
| 1 | 单表查询 | WHERE + ORDER BY |
| 2 | 内连接 | INNER JOIN 多表 |
| 3 | 左外连接 | LEFT JOIN 含NULL |
| 4 | 自连接 | category表自关联 |
| 5 | 聚合函数 | COUNT/SUM/AVG + GROUP BY |
| 6 | 日期函数 | DATE() 处理 |
| 7 | 子查询 | WHERE中嵌套SELECT |
| 8 | 相关子查询 | 引用外层表 |
| 9 | UNION | 合并结果集 |
| 10 | 多表连接 | 5+表关联 |
| 11 | 除法查询 | HAVING + 子查询 |

### 8.3 MySQL执行验证

```bash
# 连接MySQL
mysql -u root -p online_learning_platform

# 执行查询文件
source sql/complex_queries.sql
```

---

## 9. 故障排除

### 9.1 常见问题

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| ModuleNotFoundError: flask | 未安装Flask | `pip install flask` |
| 数据库文件不存在 | 首次运行未初始化 | 运行 `python app.py` |
| 登录后无权限 | Session问题 | 清除浏览器Cookie |
| 页面404 | 路由错误 | 检查URL拼写 |
| 中文乱码 | 编码问题 | 确保UTF-8 |

### 9.2 重置数据库

```bash
# 删除现有数据库
rm learning_platform.db

# 重新运行应用（自动重建）
python app.py
```

### 9.3 调试模式

app.py 中已启用调试模式：
```python
app.run(debug=True, host='0.0.0.0', port=5000)
```

---

## 10. 部署上线

### 10.1 生产环境配置

```python
# 关闭调试模式
app.run(debug=False)

# 使用环境变量设置密钥
app.secret_key = os.environ.get('SECRET_KEY', 'your-secret-key')
```

### 10.2 使用 Gunicorn

```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### 10.3 Nginx 反向代理

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /static {
        alias /path/to/online_learning_platform/static;
    }
}
```

---

## 附录：快速命令参考

```bash
# 启动开发服务器
python app.py

# 检查Python版本
python --version

# 安装依赖
pip install flask

# 查看数据库内容
sqlite3 learning_platform.db ".tables"
sqlite3 learning_platform.db "SELECT * FROM user"

# 重置数据库
rm learning_platform.db && python app.py
```

---

**文档版本**: v1.0  
**最后更新**: 2025年  
**作者**: 系统工程师
